<!DOCTYPE html>
<meta charset="utf-8">
<script src="../lib/d3.v5.min.js"></script>
<style>
.axis{
      fill: none;
      stroke:none;
}
path {
  stroke:none;
}

line{
  stroke:none;
}
.axis text {
      font-family: sans-serif;
      font-size: 15px;
  }
</style>
<body>
<script>

    //Load in the data



    rowConverter = function(d){
        return {
                Bronx: +d.Bronx,
                Brooklyn: +d.Brooklyn,
                Manhattan: +d.Manhattan,
                Queens: +d.Queens,
                "Staten Island": +d["Staten Island"],
                Crime_Type: d["Crime Type"],
                Year: +d.Year
                }
    }
    function wideToLong(wide_data){

      var long_data = [];
      wide_data.forEach( function(row) {
        // Loop through all of the columns, and for each column
        // make a new row
        Object.keys(row).forEach( function(colname) {
          // Ignore 'State' and 'Value' columns
          if(colname == "Crime_Type" || colname == "Year") {
            return
          }
          long_data.push({"City": colname, "Value": row[colname], "Year": row.Year, "Type":row.Crime_Type});
        });
      });
      return long_data
    }
    function range(start, stop, step){
      var a=[start], b=start;
      while(b<stop){b+=(step || 1);a.push(b)}
      return a;
    };
    year = 2011

    var margin = {top: 100, right: 100, bottom: 100, left: 100},
        width = 1100 - margin.left - margin.right,
        height = 1100 - margin.top - margin.bottom;
    var cellSize = 50
    function heatmap(data){
      x = d3.set(data, function(d) {return d.Type}).values()
      y = d3.set(data, function(d){return d.City}).values()

      minVal = d3.min(data,function(d){return d.Value})
      maxVal = d3.max(data, function(d){return d.Value})
      locRange = range(0, (1+cellSize)*(x.length), (1+cellSize))
      colors = 9
      colorStep = Math.floor(maxVal/colors)
      colorRange = range(0,maxVal-colorStep,colorStep).slice(1, colors)
      xScale = d3.scaleOrdinal()
              .domain(x)
              .range(locRange)
      yScale = d3.scaleOrdinal()
              .domain(y)
              .range(locRange)

      xAxis = d3.axisBottom()
              .scale(xScale)
      yAxis = d3.axisLeft()
              .scale(yScale)

      colorScale = d3.scaleThreshold()
              .domain(colorRange)
              .range(['#fff7fb','#ece7f2','#d0d1e6','#a6bddb','#74a9cf','#3690c0','#0570b0','#045a8d','#023858'])

      //create svg element
      svg = d3.select('#p1')
              .append("svg")
              .attr("width", width+margin.left+margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      border = svg.append('g')
              .attr("id", "border")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")")


      //axis labels
      yLabs = svg.append("g")
              .attr("transform", "translate(" + margin.left + "," +margin.top +")")
              .attr("class", 'y axis')
              .call(yAxis)
              .selectAll("text")
              .attr("y", cellSize/2)
      xLabs = svg.append("g")
              .attr("transform", "translate("+margin.left+"," + (cellSize)*(1+x.length)+")")
              .attr("class", "x axis")
              .call(xAxis)
              .selectAll('text')
              .attr("y", cellSize/2-5)
              .attr("x", -15)
              .attr('font-weight', 'normal')
              .style("text-anchor", "end")
              .attr("transform", function (d) {
                  return "rotate(-90)"
              })

      legend = svg.append("g")
              .attr("transform", "translate("+margin.left+"," +(2*cellSize+(cellSize)*(1+x.length))+")")

      legendData = [{x:-2*cellSize, Value:0}]
      for(i=0; i<colorRange.length; i++){
        legendData[i+1] = {x:(i*cellSize - cellSize), Value: colorRange[i]}
      }

      //enter
      cells = svg.selectAll("rect")
              .data(data)
              .enter()
              .append('g')
                .append('rect')
                .attr('class', 'cell')
                .attr('width', cellSize)
                .attr("height", cellSize)
                .attr('x', function(d) {return xScale(d.Type)+margin.left})
                .attr('y', function(d){return yScale(d.City)+margin.top})
                .attr('fill', function(d){return colorScale(d.Value)})

      legend.selectAll("rect")
              .data(legendData)
              .enter()
              .append("rect")
              .attr("class", "cell")
              .attr("width", cellSize)
              .attr("height", cellSize/2)
              .attr("x", function(d){return d.x})
              .attr('fill', function(d){ return colorScale(d.Value)})

      legendLabs = legend.append("g")
              .selectAll('text')
              .data(legendData)
              .enter()
              .append("text")
              .text(function(d){return d.Value})
                .attr("x",function(d){return d.x})
                .attr("y", cellSize)

      legendTitle = legend.append("g")
              .append("text")
              .text("Number of Crimes")
              .attr('x', -2*cellSize)
              .attr('y', -10)

    footer = svg.append("g")
              .attr("transform", "translate("+margin.left+"," +(3*cellSize+(cellSize)*(1+x.length))+")")
              .append("text")
              .text("Figure 4a: Number of crimes of each type in each neighborhood")
              .attr('x', -2*cellSize)
              .attr('y', 30)

    }
    data = d3.csv("heatmap.csv", rowConverter)
              .then(wideToLong)
              .then(function(data){return data.filter(row => row.Year == 2011)})

    data.then(heatmap)


</script>
<div id="p1"></div>

</body>
</html>
